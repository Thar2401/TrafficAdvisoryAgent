# Streamlit web application for Traffic Advisory Agent\n\nimport streamlit as st\nimport pandas as pd\nimport numpy as np\nimport plotly.express as px\nimport plotly.graph_objects as go\nfrom datetime import datetime, timedelta\nimport json\n\n# Import the traffic agent\nfrom src.traffic_agent import TrafficAdvisoryAgent\nfrom utils.config import Config\n\n# Page configuration\nst.set_page_config(\n    page_title=Config.STREAMLIT_CONFIG['page_title'],\n    page_icon=Config.STREAMLIT_CONFIG['page_icon'],\n    layout=Config.STREAMLIT_CONFIG['layout'],\n    initial_sidebar_state=\"expanded\"\n)\n\n# Custom CSS for better styling\nst.markdown(\"\"\"\n<style>\n.main-header {\n    font-size: 2.5rem;\n    color: #1f77b4;\n    text-align: center;\n    margin-bottom: 2rem;\n    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);\n}\n.metric-container {\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    padding: 1rem;\n    border-radius: 10px;\n    color: white;\n    margin: 0.5rem 0;\n}\n.insight-box {\n    background-color: #f0f2f6;\n    padding: 1rem;\n    border-radius: 8px;\n    border-left: 4px solid #1f77b4;\n    margin: 0.5rem 0;\n}\n.recommendation-box {\n    background-color: #e8f5e8;\n    padding: 1rem;\n    border-radius: 8px;\n    border-left: 4px solid #28a745;\n    margin: 0.5rem 0;\n}\n.warning-box {\n    background-color: #fff3cd;\n    padding: 1rem;\n    border-radius: 8px;\n    border-left: 4px solid #ffc107;\n    margin: 0.5rem 0;\n}\n</style>\n\"\"\", unsafe_allow_html=True)\n\n# Initialize session state\nif 'agent' not in st.session_state:\n    st.session_state.agent = None\nif 'last_recommendations' not in st.session_state:\n    st.session_state.last_recommendations = None\nif 'agent_initialized' not in st.session_state:\n    st.session_state.agent_initialized = False\n\ndef initialize_agent():\n    \"\"\"Initialize the traffic agent\"\"\"\n    if not st.session_state.agent_initialized:\n        with st.spinner('üö¶ Initializing AI Traffic Agent... This may take a moment.'):\n            try:\n                st.session_state.agent = TrafficAdvisoryAgent(auto_load_data=True)\n                st.session_state.agent_initialized = True\n                return True\n            except Exception as e:\n                st.error(f\"Failed to initialize agent: {str(e)}\")\n                return False\n    return True\n\ndef display_main_header():\n    \"\"\"Display the main application header\"\"\"\n    st.markdown('<h1 class=\"main-header\">üö¶ AI-Based Traffic Advisory Agent</h1>', unsafe_allow_html=True)\n    st.markdown(\"<p style='text-align: center; color: #666; font-size: 1.1rem;'>üéØ <strong>SDG 11: Sustainable Cities and Communities</strong> - Optimizing urban mobility for a sustainable future</p>\", unsafe_allow_html=True)\n    st.markdown(\"---\")\n\ndef display_sidebar():\n    \"\"\"Display sidebar with controls and information\"\"\"\n    st.sidebar.image(\"https://via.placeholder.com/200x100/1f77b4/white?text=Traffic+Agent\", width=200)\n    \n    st.sidebar.markdown(\"## üéõÔ∏è Control Panel\")\n    \n    # Agent status\n    if st.session_state.agent_initialized:\n        st.sidebar.success(\"‚úÖ Agent Ready\")\n        \n        # Display agent status\n        if st.sidebar.button(\"üìä Show Agent Status\"):\n            status = st.session_state.agent.get_agent_status()\n            st.sidebar.json(status)\n    else:\n        st.sidebar.error(\"‚ùå Agent Not Initialized\")\n    \n    st.sidebar.markdown(\"---\")\n    \n    # User preferences\n    st.sidebar.markdown(\"### ‚öôÔ∏è Optimization Preferences\")\n    \n    travel_time_weight = st.sidebar.slider(\"Travel Time Priority\", 0.0, 1.0, 0.4, 0.1)\n    congestion_weight = st.sidebar.slider(\"Congestion Avoidance\", 0.0, 1.0, 0.3, 0.1)\n    fuel_weight = st.sidebar.slider(\"Fuel Efficiency\", 0.0, 1.0, 0.2, 0.1)\n    env_weight = st.sidebar.slider(\"Environmental Impact\", 0.0, 1.0, 0.1, 0.1)\n    \n    # Normalize weights\n    total_weight = travel_time_weight + congestion_weight + fuel_weight + env_weight\n    if total_weight > 0:\n        user_preferences = {\n            'travel_time': travel_time_weight / total_weight,\n            'congestion': congestion_weight / total_weight,\n            'fuel_efficiency': fuel_weight / total_weight,\n            'environmental_impact': env_weight / total_weight\n        }\n    else:\n        user_preferences = None\n    \n    st.sidebar.markdown(\"---\")\n    \n    # About section\n    st.sidebar.markdown(\"### üìñ About\")\n    st.sidebar.info(\"\"\"\n    This AI agent helps optimize your travel routes considering:\n    - üö¶ Real-time traffic patterns\n    - ‚õΩ Fuel efficiency\n    - üå± Environmental impact\n    - ‚è∞ Time optimization\n    \n    **Sustainable Development Goal 11**: Making cities inclusive, safe, resilient and sustainable.\n    \"\"\")\n    \n    return user_preferences\n\ndef display_route_planner():\n    \"\"\"Display the main route planning interface\"\"\"\n    st.markdown(\"## üó∫Ô∏è Route Planner\")\n    \n    if not st.session_state.agent_initialized:\n        st.warning(\"‚ö†Ô∏è Please wait while the agent initializes...\")\n        return None, None, None\n    \n    # Get available locations\n    available_locations = st.session_state.agent.perception.get_available_locations()\n    \n    col1, col2, col3 = st.columns([2, 2, 1])\n    \n    with col1:\n        source = st.selectbox(\n            \"üìç From (Source)\",\n            available_locations,\n            index=0 if available_locations else None,\n            help=\"Select your starting location\"\n        )\n    \n    with col2:\n        destination = st.selectbox(\n            \"üéØ To (Destination)\", \n            available_locations,\n            index=1 if len(available_locations) > 1 else 0,\n            help=\"Select your destination\"\n        )\n    \n    with col3:\n        preferred_time = st.time_input(\n            \"üïê Preferred Time\",\n            value=datetime.now().time(),\n            help=\"Your preferred departure time\"\n        )\n    \n    return source, destination, preferred_time.strftime(\"%H:%M\")\n\ndef process_route_request(source, destination, preferred_time, user_preferences):\n    \"\"\"Process the route request and display results\"\"\"\n    if not all([source, destination]):\n        st.warning(\"Please select both source and destination.\")\n        return\n    \n    if source == destination:\n        st.error(\"Source and destination cannot be the same!\")\n        return\n    \n    # Process request button\n    if st.button(\"üöÄ Get Traffic Advisory\", type=\"primary\"):\n        with st.spinner('üîÑ Analyzing traffic patterns and optimizing routes...'):\n            try:\n                # Process the request\n                recommendations = st.session_state.agent.process_request(\n                    source=source,\n                    destination=destination,\n                    preferred_time=preferred_time,\n                    user_preferences=user_preferences\n                )\n                \n                st.session_state.last_recommendations = recommendations\n                \n                if 'error' in recommendations:\n                    st.error(f\"‚ùå {recommendations['error']}\")\n                    return\n                \n                display_recommendations(recommendations)\n                \n            except Exception as e:\n                st.error(f\"‚ùå An error occurred: {str(e)}\")\n\ndef display_recommendations(recommendations):\n    \"\"\"Display the traffic recommendations\"\"\"\n    st.markdown(\"## üéØ Traffic Advisory Results\")\n    \n    # Primary recommendation\n    primary = recommendations.get('primary_recommendation', {})\n    \n    if 'error' not in primary:\n        st.markdown('<div class=\"recommendation-box\">', unsafe_allow_html=True)\n        st.markdown(\"### üåü **Primary Recommendation**\")\n        \n        col1, col2, col3, col4 = st.columns(4)\n        \n        with col1:\n            st.metric(\n                \"üõ£Ô∏è Route\", \n                primary['route_description'],\n                help=\"Recommended route\"\n            )\n        \n        with col2:\n            st.metric(\n                \"üïê Departure\", \n                primary['recommended_departure'],\n                help=\"Optimal departure time\"\n            )\n        \n        with col3:\n            st.metric(\n                \"‚è±Ô∏è Travel Time\", \n                f\"{primary['travel_metrics']['estimated_travel_time_min']} min\",\n                help=\"Estimated travel duration\"\n            )\n        \n        with col4:\n            st.metric(\n                \"üö¶ Traffic Level\", \n                primary['travel_metrics']['traffic_level'].title(),\n                help=\"Expected traffic conditions\"\n            )\n        \n        # Additional metrics\n        col5, col6, col7, col8 = st.columns(4)\n        \n        with col5:\n            st.metric(\n                \"üìè Distance\", \n                f\"{primary['travel_metrics']['distance_km']} km\",\n                help=\"Route distance\"\n            )\n        \n        with col6:\n            st.metric(\n                \"‚õΩ Fuel\", \n                f\"{primary['environmental_impact']['fuel_consumption_l']} L\",\n                help=\"Estimated fuel consumption\"\n            )\n        \n        with col7:\n            st.metric(\n                \"üå± CO2\", \n                f\"{primary['environmental_impact']['co2_emission_kg']} kg\",\n                help=\"Carbon dioxide emissions\"\n            )\n        \n        with col8:\n            st.metric(\n                \"‚≠ê Rating\", \n                primary['recommendation_strength'],\n                help=\"Recommendation confidence\"\n            )\n        \n        st.markdown('</div>', unsafe_allow_html=True)\n    \n    # Alternative options\n    alternatives = recommendations.get('alternative_options', [])\n    if alternatives:\n        st.markdown(\"### üîÄ Alternative Options\")\n        \n        for i, alt in enumerate(alternatives[:2], 1):\n            with st.expander(f\"Option {i}: {alt['route_description']}\"):\n                col1, col2, col3 = st.columns(3)\n                \n                with col1:\n                    st.write(f\"üïê **Departure:** {alt['departure_time']}\")\n                    st.write(f\"‚è±Ô∏è **Travel Time:** {alt['key_metrics']['travel_time_min']} min\")\n                \n                with col2:\n                    st.write(f\"üö¶ **Traffic:** {alt['key_metrics']['traffic_level']}\")\n                    st.write(f\"‚õΩ **Fuel:** {alt['key_metrics']['fuel_consumption_l']} L\")\n                \n                with col3:\n                    st.write(f\"üéØ **Best for:** {alt['best_for']}\")\n                    \n                    # Comparison to primary\n                    comparison = alt.get('comparison_to_primary', {})\n                    if comparison:\n                        if comparison.get('is_faster', False):\n                            st.success(f\"‚ö° {abs(comparison['time_difference_min']):.1f} min faster\")\n                        elif comparison.get('time_difference_min', 0) > 0:\n                            st.info(f\"‚è±Ô∏è {comparison['time_difference_min']:.1f} min slower\")\n    \n    # Display visualizations\n    display_visualizations(recommendations)\n    \n    # Traffic insights\n    insights = recommendations.get('traffic_insights', [])\n    if insights:\n        st.markdown(\"### üí° Traffic Insights\")\n        st.markdown('<div class=\"insight-box\">', unsafe_allow_html=True)\n        for insight in insights:\n            st.write(f\"‚Ä¢ {insight}\")\n        st.markdown('</div>', unsafe_allow_html=True)\n    \n    # Sustainability recommendations\n    sustainability = recommendations.get('sustainability_insights', {})\n    improvements = sustainability.get('improvement_opportunities', [])\n    if improvements:\n        st.markdown(\"### üå± Sustainability Tips\")\n        st.markdown('<div class=\"recommendation-box\">', unsafe_allow_html=True)\n        for tip in improvements[:4]:\n            st.write(f\"‚Ä¢ {tip}\")\n        st.markdown('</div>', unsafe_allow_html=True)\n    \n    # Action items\n    actions = recommendations.get('action_items', [])\n    if actions:\n        st.markdown(\"### ‚úÖ Action Items\")\n        for action in actions:\n            priority_emoji = {\"high\": \"üî¥\", \"medium\": \"üü°\", \"low\": \"üü¢\"}\n            emoji = priority_emoji.get(action.get('priority', 'medium'), 'üîµ')\n            st.write(f\"{emoji} **{action['action']}**: {action['description']}\")\n\ndef display_visualizations(recommendations):\n    \"\"\"Display traffic visualizations\"\"\"\n    st.markdown(\"### üìä Traffic Analysis\")\n    \n    # Get analysis details\n    analysis = recommendations.get('analysis_details', {})\n    \n    if analysis:\n        col1, col2 = st.columns(2)\n        \n        with col1:\n            # Hourly congestion pattern\n            hourly_patterns = analysis.get('congestion_patterns', {}).get('hourly_patterns', {})\n            if hourly_patterns:\n                hours = list(hourly_patterns.keys())\n                congestion_levels = [hourly_patterns[h]['mean'] for h in hours]\n                \n                fig = px.line(\n                    x=hours,\n                    y=congestion_levels,\n                    title=\"üïê Hourly Traffic Congestion Pattern\",\n                    labels={'x': 'Hour of Day', 'y': 'Average Congestion Score'}\n                )\n                fig.update_traces(line=dict(color='#1f77b4', width=3))\n                fig.update_layout(height=400)\n                st.plotly_chart(fig, use_container_width=True)\n        \n        with col2:\n            # Route comparison\n            optimization_result = analysis.get('optimization_result', {})\n            routes = optimization_result.get('ranked_routes', [])[:5]\n            \n            if routes:\n                route_names = [r['description'][:30] + '...' if len(r['description']) > 30 else r['description'] for r in routes]\n                travel_times = [r['travel_time_min'] for r in routes]\n                \n                fig = px.bar(\n                    x=route_names,\n                    y=travel_times,\n                    title=\"‚è±Ô∏è Route Comparison (Travel Time)\",\n                    labels={'x': 'Route', 'y': 'Travel Time (minutes)'}\n                )\n                fig.update_traces(marker_color='#28a745')\n                fig.update_layout(height=400, xaxis_tickangle=-45)\n                st.plotly_chart(fig, use_container_width=True)\n        \n        # Sustainability comparison\n        sustainability_analysis = analysis.get('sustainability_analysis', {})\n        route_sustainability = sustainability_analysis.get('route_sustainability', [])\n        \n        if route_sustainability:\n            st.markdown(\"#### üå± Environmental Impact Comparison\")\n            \n            df_sustainability = pd.DataFrame([\n                {\n                    'Route': r['description'][:30] + '...' if len(r['description']) > 30 else r['description'],\n                    'CO2 Emissions (kg)': r['co2_emission_kg'],\n                    'Fuel Consumption (L)': r['fuel_consumption_l']\n                }\n                for r in route_sustainability[:5]\n            ])\n            \n            fig = px.scatter(\n                df_sustainability,\n                x='Fuel Consumption (L)',\n                y='CO2 Emissions (kg)',\n                hover_data=['Route'],\n                title=\"üåç Environmental Impact: Fuel vs CO2 Emissions\",\n                color='CO2 Emissions (kg)',\n                size='Fuel Consumption (L)',\n                color_continuous_scale='Reds_r'\n            )\n            fig.update_layout(height=400)\n            st.plotly_chart(fig, use_container_width=True)\n\ndef display_traffic_insights_tab():\n    \"\"\"Display general traffic insights\"\"\"\n    st.markdown(\"## üìä Traffic Insights Dashboard\")\n    \n    if not st.session_state.agent_initialized:\n        st.warning(\"‚ö†Ô∏è Agent not initialized. Please use the Route Planner first.\")\n        return\n    \n    # Location selector\n    available_locations = st.session_state.agent.perception.get_available_locations()\n    \n    col1, col2 = st.columns(2)\n    \n    with col1:\n        selected_location = st.selectbox(\n            \"üìç Select Location for Analysis\",\n            ['All Locations'] + available_locations\n        )\n    \n    with col2:\n        selected_hour = st.selectbox(\n            \"üïê Select Hour for Analysis\",\n            ['All Hours'] + [f\"{h:02d}:00\" for h in range(24)]\n        )\n    \n    # Get insights\n    location = None if selected_location == 'All Locations' else selected_location\n    hour = None if selected_hour == 'All Hours' else int(selected_hour[:2])\n    \n    insights = st.session_state.agent.get_traffic_insights(location, hour)\n    \n    if insights:\n        # Display location analysis\n        if 'location_analysis' in insights:\n            st.markdown(f\"### üìç Analysis for {location}\")\n            loc_analysis = insights['location_analysis']\n            \n            col1, col2, col3, col4 = st.columns(4)\n            with col1:\n                st.metric(\"Average Congestion\", f\"{loc_analysis['average_congestion']:.3f}\")\n            with col2:\n                st.metric(\"Peak Congestion\", f\"{loc_analysis['peak_congestion']:.3f}\")\n            with col3:\n                best_hours = ', '.join([f\"{h:02d}:00\" for h in loc_analysis['best_hours']])\n                st.metric(\"Best Hours\", best_hours)\n            with col4:\n                worst_hours = ', '.join([f\"{h:02d}:00\" for h in loc_analysis['worst_hours']])\n                st.metric(\"Worst Hours\", worst_hours)\n        \n        # Display hour analysis\n        if 'hour_analysis' in insights:\n            st.markdown(f\"### üïê Analysis for {selected_hour}\")\n            hour_analysis = insights['hour_analysis']\n            \n            col1, col2, col3 = st.columns(3)\n            with col1:\n                st.metric(\"Average Congestion\", f\"{hour_analysis['average_congestion']:.3f}\")\n            with col2:\n                st.metric(\"Typical Speed\", f\"{hour_analysis['typical_speed']:.1f} km/h\")\n            with col3:\n                st.metric(\"Affected Routes\", hour_analysis['affected_routes'])\n            \n            # Traffic level distribution\n            if 'traffic_level_distribution' in hour_analysis:\n                dist = hour_analysis['traffic_level_distribution']\n                fig = px.pie(\n                    values=list(dist.values()),\n                    names=list(dist.keys()),\n                    title=f\"Traffic Level Distribution for {selected_hour}\"\n                )\n                st.plotly_chart(fig, use_container_width=True)\n        \n        # General patterns\n        if 'general_patterns' in insights:\n            st.markdown(\"### üåê General Traffic Patterns\")\n            patterns = insights['general_patterns']\n            \n            # Most popular routes\n            if 'most_popular_routes' in patterns:\n                st.markdown(\"#### üèÜ Most Popular Routes\")\n                popular_routes = patterns['most_popular_routes']\n                \n                df_popular = pd.DataFrame([\n                    {'Route': route, 'Frequency': freq}\n                    for route, freq in list(popular_routes.items())[:10]\n                ])\n                \n                fig = px.bar(\n                    df_popular,\n                    x='Frequency',\n                    y='Route',\n                    orientation='h',\n                    title=\"Route Popularity\"\n                )\n                st.plotly_chart(fig, use_container_width=True)\n\ndef main():\n    \"\"\"Main application function\"\"\"\n    # Initialize agent\n    initialize_agent()\n    \n    # Display header\n    display_main_header()\n    \n    # Display sidebar and get preferences\n    user_preferences = display_sidebar()\n    \n    # Create tabs\n    tab1, tab2, tab3 = st.tabs([\"üó∫Ô∏è Route Planner\", \"üìä Traffic Insights\", \"üìã Export Results\"])\n    \n    with tab1:\n        # Main route planning interface\n        source, destination, preferred_time = display_route_planner()\n        \n        if st.session_state.agent_initialized and source and destination:\n            process_route_request(source, destination, preferred_time, user_preferences)\n    \n    with tab2:\n        # Traffic insights dashboard\n        display_traffic_insights_tab()\n    \n    with tab3:\n        # Export functionality\n        st.markdown(\"## üìã Export Results\")\n        \n        if st.session_state.last_recommendations:\n            st.markdown(\"### üìÑ Last Recommendation Results\")\n            \n            # Display formatted results\n            formatted_results = st.session_state.agent.action.format_for_display(\n                st.session_state.last_recommendations, 'detailed'\n            )\n            \n            st.text_area(\n                \"Detailed Report\",\n                formatted_results,\n                height=400,\n                help=\"Copy this report to share or save\"\n            )\n            \n            # Download buttons\n            col1, col2 = st.columns(2)\n            \n            with col1:\n                if st.button(\"üì• Download JSON\"):\n                    json_data = json.dumps(st.session_state.last_recommendations, indent=2, default=str)\n                    st.download_button(\n                        label=\"Download JSON Report\",\n                        data=json_data,\n                        file_name=f\"traffic_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json\",\n                        mime=\"application/json\"\n                    )\n            \n            with col2:\n                if st.button(\"üìÑ Download Text Report\"):\n                    st.download_button(\n                        label=\"Download Text Report\",\n                        data=formatted_results,\n                        file_name=f\"traffic_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt\",\n                        mime=\"text/plain\"\n                    )\n        else:\n            st.info(\"üîç No results to export. Please run a route analysis first.\")\n    \n    # Footer\n    st.markdown(\"---\")\n    st.markdown(\"\"\"\n    <div style='text-align: center; color: #666; font-size: 0.9rem;'>\n        üåç <strong>Contributing to SDG 11: Sustainable Cities and Communities</strong><br>\n        AI-powered traffic optimization for reduced congestion and environmental impact\n    </div>\n    \"\"\", unsafe_allow_html=True)\n\nif __name__ == \"__main__\":\n    main()"